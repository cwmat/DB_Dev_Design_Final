-- ******************************************************
-- smell_map_qc.sql 
--
-- Loader for the Smell Map Database
--
-- Description:	This script tests column cosntraints, entity entegrity, and 
-- referential integrity.
--
-- Author:  Charles Mateer
--
-- Student:  Charles Mateer cmateer@g.harvard.edu
--
-- Date:   November, 2017
--
-- ******************************************************

-- ******************************************************
--    SPOOL SESSION
-- ******************************************************

spool smell_map_qc.lst


-- ******************************************************
--    QUALITY CONTROLS
--
-- Note:  Tests TODO
-- ******************************************************

/* Check column constraints */
-- View columns with value constraints
SELECT table_name, constraint_name, search_condition  FROM
user_constraints WHERE constraint_type='C' ORDER BY table_name;

-- This next several tests will yield the following error which validates our constraint:
-- ORA-02290: check constraint violated 
-- smell_type rg_smell_type between '01' - '03'
INSERT INTO smell_type VALUES ('00', 'Desc');
INSERT INTO smell_type VALUES ('04', 'Desc');
INSERT INTO smell_type VALUES ('1', 'Desc');

-- This description is too long
INSERT INTO smell_type VALUES('01', 'Description is too long and will fail');

-- smell_magnitude rg_smell_magnitude between '01' - '10'
INSERT INTO smell_magnitude VALUES ('1', 'Description', '0.1');
INSERT INTO smell_magnitude VALUES ('11', 'Description', '0.1');

-- Too much precision
INSERT INTO smell_magnitude VALUES ('01', 'Description', '0.1111111');

-- smell_type rg_smell_type_profile between '01' - '03'
DECLARE

    angel_id number(11, 0);
    adamo_id number(11, 0);
    kay_id number(11, 0);
    geanie_id number(11, 0);

BEGIN

    SELECT user_id INTO angel_id FROM user_account WHERE first_name = 'Angel';
    SELECT user_id INTO adamo_id FROM user_account WHERE first_name = 'Adamo';
    SELECT user_id INTO kay_id FROM user_account WHERE first_name = 'Kay-Re';
    SELECT user_id INTO geanie_id FROM user_account WHERE first_name = 'Geanie';

    -- Solo
    new_smell_profile(angel_id, 37.55119634300007192, -77.47205794499996045, '1', '10', 'Basic Desc');

    -- smell_magnitude rg_smell_magnitude_profile between '01' - '10'
    new_smell_profile(angel_id, 37.55119634300007192, -77.47205794499996045, '01', '1', 'Basic Desc');


END;
/



/* Check entity integrity */
-- Ryan's pk_col script will list out all of the columns that are PKs so that we may use
-- them as reference when creating our test cases.  However, by convention, we have made it easy
-- to pick out our PKs by name.  
column table_name format A15
column column_name format A25
column constraint_name format A30
select a.table_name, column_name, a.constraint_name
from user_constraints a, user_cons_columns b
where a.constraint_type='P'
and a.constraint_name=b.constraint_name
order by table_name;

-- Try duplicate and null on each PK
-- This will succeed
/* User */
INSERT INTO user_account VALUES (5, 'test', 'test', 'test', 'test', 'test');
-- This will fail
INSERT INTO user_account VALUES (5, 'test', 'test', 'test', 'test', 'test');
INSERT INTO user_account VALUES (NULL, 'test', 'test', 'test', 'test', 'test');
-- Removing
DELETE FROM user_account WHERE user_id = 5;

/* Smell Type */
-- This will succeed (or fail depending on if it has been loaded before or after smell_map_load.sql)
INSERT INTO smell_type VALUES ('01', 'Desc');
-- This will fail
INSERT INTO smell_type VALUES ('01', 'Desc');
INSERT INTO smell_type VALUES (NULL, 'Desc');
-- Removing
DELETE FROM smell_type WHERE type_id = '01';

/* Smell Magnitude */
-- This will succeed (or fail depending on if it has been loaded before or after smell_map_load.sql)
INSERT INTO smell_magnitude VALUES ('01', 'Desc', 0.1);
-- This will fail
INSERT INTO smell_magnitude VALUES ('01', 'Desc', 0.1);
INSERT INTO smell_magnitude VALUES (NULL, 'Desc', 0.1);
-- Removing
DELETE FROM smell_magnitude WHERE magnitude_id = '01';

/* Smellscape */
-- These will fail due to duplicates
INSERT INTO smellscape VALUES ('517600102003036', SDO_UTIL.FROM_WKTGEOMETRY ('MULTIPOLYGON (((-77.466233350999971 37.58788650200006, -77.466154349999954 37.587762501000043, -77.466038349999963 37.58761250200007, -77.465909350999937 37.587459502000058, -77.465828349999981 37.587396502000047, -77.465710349999938 37.587406502000078, -77.465637349999952 37.587437502000057, -77.465336349999973 37.58757150200006, -77.465314350999961 37.587654501000031, -77.465330349999988 37.587776502000054, -77.465370349999944 37.587881502000073, -77.465407349999964 37.588124502000028, -77.465417349999939 37.588245502000063, -77.465414349999946 37.589355502000046, -77.465442349999989 37.589658502000077, -77.465490349999982 37.589780502000053, -77.465643350999983 37.589961502000051, -77.465796349999948 37.590106502000026, -77.465869349999934 37.590165502000048, -77.465944349999972 37.590203502000065, -77.46603534999997 37.590211502000045, -77.466141349999987 37.590196502000026, -77.466197349999959 37.590182502000062, -77.466317350999987 37.590155503000062, -77.466629350999938 37.59007450200005, -77.466761349999956 37.590036502000032, -77.466964350999945 37.589965502000041, -77.467017349999935 37.589952502000074, -77.467075349999959 37.589945502000035, -77.467122350999944 37.589961502000051, -77.467155350999974 37.589983502000052, -77.467196350999984 37.59002950200005, -77.467234349999956 37.59010750200008, -77.46727735099995 37.59003750200003, -77.46733734999998 37.590001502000064, -77.467342350999957 37.589999503000058, -77.467462349999948 37.589962502000049, -77.467659350999952 37.589883502000077, -77.467727350999951 37.589853503000029, -77.467784350999978 37.589828502000046, -77.467842349999955 37.589803502000052, -77.467925350999963 37.589757502000055, -77.46796335099998 37.589736502000051, -77.468086350999954 37.589633502000027, -77.468091350999941 37.589630502000034, -77.468144350999978 37.589551502000063, -77.468206350999935 37.58933950200003, -77.468210350999982 37.58923750200006, -77.468165351999971 37.58914350200007, -77.468117349999943 37.589075502000071, -77.468001350999941 37.588909502000035, -77.467260350999936 37.58762050200005, -77.466733350999959 37.587660502000062, -77.466233350999971 37.58788650200006)))'));
INSERT INTO smellscape VALUES ('517600102003036', SDO_UTIL.FROM_WKTGEOMETRY ('MULTIPOLYGON (((-77.466233350999971 37.58788650200006, -77.466154349999954 37.587762501000043, -77.466038349999963 37.58761250200007, -77.465909350999937 37.587459502000058, -77.465828349999981 37.587396502000047, -77.465710349999938 37.587406502000078, -77.465637349999952 37.587437502000057, -77.465336349999973 37.58757150200006, -77.465314350999961 37.587654501000031, -77.465330349999988 37.587776502000054, -77.465370349999944 37.587881502000073, -77.465407349999964 37.588124502000028, -77.465417349999939 37.588245502000063, -77.465414349999946 37.589355502000046, -77.465442349999989 37.589658502000077, -77.465490349999982 37.589780502000053, -77.465643350999983 37.589961502000051, -77.465796349999948 37.590106502000026, -77.465869349999934 37.590165502000048, -77.465944349999972 37.590203502000065, -77.46603534999997 37.590211502000045, -77.466141349999987 37.590196502000026, -77.466197349999959 37.590182502000062, -77.466317350999987 37.590155503000062, -77.466629350999938 37.59007450200005, -77.466761349999956 37.590036502000032, -77.466964350999945 37.589965502000041, -77.467017349999935 37.589952502000074, -77.467075349999959 37.589945502000035, -77.467122350999944 37.589961502000051, -77.467155350999974 37.589983502000052, -77.467196350999984 37.59002950200005, -77.467234349999956 37.59010750200008, -77.46727735099995 37.59003750200003, -77.46733734999998 37.590001502000064, -77.467342350999957 37.589999503000058, -77.467462349999948 37.589962502000049, -77.467659350999952 37.589883502000077, -77.467727350999951 37.589853503000029, -77.467784350999978 37.589828502000046, -77.467842349999955 37.589803502000052, -77.467925350999963 37.589757502000055, -77.46796335099998 37.589736502000051, -77.468086350999954 37.589633502000027, -77.468091350999941 37.589630502000034, -77.468144350999978 37.589551502000063, -77.468206350999935 37.58933950200003, -77.468210350999982 37.58923750200006, -77.468165351999971 37.58914350200007, -77.468117349999943 37.589075502000071, -77.468001350999941 37.588909502000035, -77.467260350999936 37.58762050200005, -77.466733350999959 37.587660502000062, -77.466233350999971 37.58788650200006)))'));
-- This will fail due to nulls
INSERT INTO smellscape VALUES (NULL, SDO_UTIL.FROM_WKTGEOMETRY ('MULTIPOLYGON (((-77.466233350999971 37.58788650200006, -77.466154349999954 37.587762501000043, -77.466038349999963 37.58761250200007, -77.465909350999937 37.587459502000058, -77.465828349999981 37.587396502000047, -77.465710349999938 37.587406502000078, -77.465637349999952 37.587437502000057, -77.465336349999973 37.58757150200006, -77.465314350999961 37.587654501000031, -77.465330349999988 37.587776502000054, -77.465370349999944 37.587881502000073, -77.465407349999964 37.588124502000028, -77.465417349999939 37.588245502000063, -77.465414349999946 37.589355502000046, -77.465442349999989 37.589658502000077, -77.465490349999982 37.589780502000053, -77.465643350999983 37.589961502000051, -77.465796349999948 37.590106502000026, -77.465869349999934 37.590165502000048, -77.465944349999972 37.590203502000065, -77.46603534999997 37.590211502000045, -77.466141349999987 37.590196502000026, -77.466197349999959 37.590182502000062, -77.466317350999987 37.590155503000062, -77.466629350999938 37.59007450200005, -77.466761349999956 37.590036502000032, -77.466964350999945 37.589965502000041, -77.467017349999935 37.589952502000074, -77.467075349999959 37.589945502000035, -77.467122350999944 37.589961502000051, -77.467155350999974 37.589983502000052, -77.467196350999984 37.59002950200005, -77.467234349999956 37.59010750200008, -77.46727735099995 37.59003750200003, -77.46733734999998 37.590001502000064, -77.467342350999957 37.589999503000058, -77.467462349999948 37.589962502000049, -77.467659350999952 37.589883502000077, -77.467727350999951 37.589853503000029, -77.467784350999978 37.589828502000046, -77.467842349999955 37.589803502000052, -77.467925350999963 37.589757502000055, -77.46796335099998 37.589736502000051, -77.468086350999954 37.589633502000027, -77.468091350999941 37.589630502000034, -77.468144350999978 37.589551502000063, -77.468206350999935 37.58933950200003, -77.468210350999982 37.58923750200006, -77.468165351999971 37.58914350200007, -77.468117349999943 37.589075502000071, -77.468001350999941 37.588909502000035, -77.467260350999936 37.58762050200005, -77.466733350999959 37.587660502000062, -77.466233350999971 37.58788650200006)))'));

/* Smell Profile */
DECLARE

    angel_id number(11, 0);
    adamo_id number(11, 0);
    kay_id number(11, 0);
    geanie_id number(11, 0);

BEGIN
    -- This portion depends on smell_map_load.sql already having been run.
    SELECT user_id INTO angel_id FROM user_account WHERE first_name = 'Angel';
    SELECT user_id INTO adamo_id FROM user_account WHERE first_name = 'Adamo';
    SELECT user_id INTO kay_id FROM user_account WHERE first_name = 'Kay-Re';
    SELECT user_id INTO geanie_id FROM user_account WHERE first_name = 'Geanie';

    -- This is a repeat and will fail
    new_smell_profile(angel_id, 37.55119634300007192, -77.47205794499996045, '01', '10', 'Basic Desc');

    -- This will fail due to nulls
    new_smell_profile(NULL, 37.55119634300007192, -77.47205794499996045, '01', '10', 'Basic Desc');

END;
/

/* Comment Log */
-- This will fail due to duplicates
INSERT INTO comment_log (1, 1, '517600102003036', '01-NOV-17', desc);
INSERT INTO comment_log (1, 1, '517600102003036', '01-NOV-17', desc);
-- This will fail due to nulls
INSERT INTO comment_log (NULL, 1, '517600102003036', '01-NOV-17', desc);

/* Subscription Log */
-- This will fail due to duplicates
INSERT INTO subscription_log (1, 1, '517600102003036', '01-NOV-17');
INSERT INTO subscription_log (1, 1, '517600102003036', '01-NOV-17');
-- This will fail due to nulls
INSERT INTO subscription_log (NULL, 1, '517600102003036', '01-NOV-17');




/* Check referential integrity */
-- Ryan's fk_col script will show us which FK constraints we have and the constraint name
-- along with associated reference column.  This information will help us build our test cases.
column table_name format A15
column constraint_name format A30
column column_name format A30
select a.table_name, a.constraint_name, column_name
from user_constraints a, user_cons_columns b
where a.constraint_type='R'
and a.constraint_name=b.constraint_name
order by table_name, a.constraint_name;

-- Test adding a FK that does not correspond to a PK.
/* Smell Profile */
-- This will fail as there is no Smellscape with this FIPS
INSERT INTO smell_profile VALUES ('1111111111', 1, 37.55119634300007192, -77.47205794499996045, SDO_GEOMETRY('POINT (-77.47205794499996045, 37.55119634300007192)', 8307), '01', '01', 'Desc');
-- This will fail as there is no smell type with that ID
INSERT INTO smell_profile VALUES ('517600102003036', 4, 37.55119634300007192, -77.47205794499996045, SDO_GEOMETRY('POINT (-77.47205794499996045, 37.55119634300007192)', 8307), '11', '01', 'Desc');
-- This will fail as there is no smell magnitude with that ID
INSERT INTO smell_profile VALUES ('517600102003036', 4, 37.55119634300007192, -77.47205794499996045, SDO_GEOMETRY('POINT (-77.47205794499996045, 37.55119634300007192)', 8307), '01', '11', 'Desc');
-- This will fail as there is no user with this ID
INSERT INTO smell_profile VALUES ('517600102003036', 10, 37.55119634300007192, -77.47205794499996045, SDO_GEOMETRY('POINT (-77.47205794499996045, 37.55119634300007192)', 8307), '01', '01', 'Desc');


/* Comment Log */
-- This will fail as there is no user with this ID
INSERT INTO comment_log (1, 10, '517600102003036', '01-NOV-17', desc);
-- This will fail as there is no Smellscape with this FIPS
INSERT INTO comment_log (1, 2, '1111111111', '01-NOV-17', desc);


/* Subscription Log */
-- This will fail as there is no user with this ID
INSERT INTO subscription_log (1, 10, '517600102003036', '01-NOV-17');
-- This will fail as there is no Smellscape with this FIPS
INSERT INTO subscription_log (1, 2, '1111111111', '01-NOV-17');


-- Attempt to delete a parent record before the associated default FK record.
/* Imapcts Smell Profile, Comment Log, and Subscription Log */
DELETE FROM user_account WHERE user_id = 1;

/* Imapcts Smell Profile, Comment Log, and Subscription Log */
DELETE FROM smellscape WHERE fips_code = '517600107002002';

/* Impacts Smell Profile */
DELETE FROM smell_type WHERE type_id = '01';
DELETE FROM smell_magnitude WHERE magnitude_id = '01';


-- ******************************************************
--    END SESSION
-- ******************************************************

spool off
